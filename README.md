# Home Energy Retrofit Portal BETA

This repository was cloned from [HUG2 Portal](https://github.com/UKGovernmentBEIS/desnz-home-energy-retrofit-portal-beta) in December 2024, keeping all previous commits.

The code was then adapted into the WH:LG service.

Note, the WH:LG project is split across 2 repositories:
- The [desnz-warm-homes-local-grant repository](https://github.com/UKGovernmentBEIS/desnz-warm-homes-local-grant), which runs the user site responsible for generating WH:LG referrals.
- This one, which runs the admin site responsible for viewing these referrals.

## Local setup

### Pre-requisites

- .Net 8 (https://dotnet.microsoft.com/en-us/download/dotnet/8.0)
- Install EF Core CLI tools (https://docs.microsoft.com/en-us/ef/core/cli/dotnet)
- Node v14+ (https://nodejs.org/en/)
- If you're using Rider then you will need to install the ".net core user secrets" plugin
- Download and configure Minio (see below)
  - [Windows](https://min.io/download#/windows)
  - [Mac](https://min.io/docs/minio/macos/index.html#procedure)

In WhlgPortalWebsite run `npm install`

#### Minio

The portal site lists files hosted in an S3 bucket. These files are generated by the [desnz-warm-homes-local-grant repository](https://github.com/UKGovernmentBEIS/desnz-warm-homes-local-grant).

For local development we need a fake S3 bucket to connect to.
To use [Minio](https://min.io/) to provide a local S3 bucket follow these steps:
1. Download minio
   * [Windows](https://min.io/download#/windows)
   * [Mac](https://min.io/docs/minio/macos/index.html#procedure)
2. Put the executable somewhere on your machine (e.g. c:\Program Files\Minio)
3. Decide on a folder for Minio to store its data in (e.g. c:\data\minio)
4. To run the server:
   * Windows
     * Open a PowerShell window and go to the folder that you put Minio in
     * Run `.\minio.exe server <path to data folder> --console-address :9090`
   * Mac:
     * Open any terminal
     * Run `export MINIO_CONFIG_ENV_FILE=/etc/default/minio`
     * Run `minio server <path to data folder> --console-address :9090`
5. The first time that you do this:
    1. Visit http://localhost:9090
    2. Login (default is minioadmin/minioadmin)
    3. Create a new bucket called `desnz-whlg-portal-referrals`

### APIs

The app communicates with a number of APIs. You will need to obtain and configure credentials for these APIs in your user secrets file.

You can find the values for these secrets in the BEIS folder in [Keeper](https://keepersecurity.eu/vault/).

In Rider:
- Right-click on the `WhlgPortalWebsite` project
- Select `Tools`
- Select `Open Project User Secrets`

Fill in the opened `secrets.json` file with:

```json
{
    "Authentication": {
        "Cognito": {
            "ClientId": "<app client id from AWS Cognito>",
            "ClientSecret": "<app client secret from AWS Cognito>",
            "MetadataAddress": "https://cognito-idp.{your-region-id}.amazonaws.com/{your-user-pool-id}/.well-known/openid-configuration",
            "SignOutUrl": "{cognito-domain}/logout?client_id={client-id}&logout_uri=https://localhost:5001/portal/sign-out"
        }
    },

    "GovUkNotify": {
        "ApiKey": "<REAL_VALUE_HERE>"
    }
}
```

You can also add secrets with `dotnet user-secrets`, just pipe the JSON you want to be added to it e.g.
```
cat secrets.json | dotnet user-secrets set
```

### Local database setup

#### Windows
- Download the installer and PostgreSQL 15 [here](https://www.postgresql.org/download/windows/)
- Follow default installation steps (no additional software is required from Stack Builder upon completion)
    - You may be prompted for a password for the postgres user and a port (good defaults are "postgres" and "5432", respectively). If you choose your own, you will have to update the connection string in appsettings.json

#### Mac
- Select a download option from [here](https://www.postgresql.org/download/macosx/) and download PostgreSQL 15
    - The [Postgres.app](https://postgresapp.com/) option works well
- Initialise a server with the following configuration (or update `PostgreSQLConnection` in `appsettings.json` to match your own):
    - Port: `5432`
    - User: `postgres`
    - Password: `postgres`

Once the server is running, you should be able to run the project locally.

For further information on interacting with the database and using migrations, please see [here](Documentation/database.md).

### Accessing the admin portal

Before signing up to the portal and viewing referrals there are a few steps required:

[//]: # (TODO - PC-1629: Update link to WH:LG common tasks Swiki page)
1. Follow step 1 'Onboarding Local Authorities and Consortiums' [here](https://softwiretech.atlassian.net/wiki/spaces/Support/pages/20606746709/DESNZ+HUG2+Common+Tasks), using `dev` anywhere `[env]` is mentioned.
   - Use the email you plan to use to sign up to the local referrals site on.
   - Custodian/consortium codes of LAs/Consortia to be associated with user can be found in [LocalAuthorityData.cs](WhlgPortalWebsite.BusinessLogic/Models/LocalAuthorityData.cs)
     - You'll want to include some that are taking part in the scheme - `5060` is an LA that is.
   - The reason this step is necessary is that the local sign up & sign in is linked to the dev environment AWS Cognito. There is a check in place that won't allow any user emails not in the dev environment Users table to sign up. 
2. Run the following management shell scripts locally - see [here](Documentation/management-shell-scripts.md) for how to do this:
   1. `AddAllMissingAuthoritiesToDatabase` 
   2. `AddLas` using your login email and the custodian codes of LAs you want to view referrals for
   3. `AddConsortia` using your login email and the consortium codes of Consortia you want to view referrals for

### Running the service locally

- In your Minio folder run Minio `.\minio.exe server <path to data folder> --console-address :9090`
- In Rider build the solution
- In `WhlgPortalWebsite` run `npm run watch`
- In Rider run the `WhlgPortalWebsite` project
- In a browser, visit https://localhost:5001/portal (the `/portal` is important!)
- You should now be able to sign up using the email address you completed the steps with in 'Accessing the admin portal' above.
  - This will create a Cognito user for you in the dev environment.
- After signing up, you should now be able to sign in with that user and view any referrals for the LAs/Consortia you configured above.

### Running tests

- In the project explorer on the left, right click on `WhlgPortalWebsite.UnitTests` and select `Run Unit Tests`
- Note, if you've previously run `npm run watch` you'll have to terminate this (`ctrl`/`cmd` + `c`) before running the tests.

### Making frontend changes

For instructions on making changes to the frontend, see [here](Documentation/making-frontend-changes.md).

## Development process

We follow a process similar to git-flow, with 3 branches corresponding to each of the environments:
- `develop` - Dev ([https://dev.check-eligibility-for-home-upgrade-grant.service.gov.uk/portal])
- `staging` - UAT ([https://uat.check-eligibility-for-home-upgrade-grant.service.gov.uk/portal])
- `main` - Production ([https://check-eligibility-for-home-upgrade-grant.service.gov.uk/portal])

For normal development:
- Create a branch from `develop`
- Make changes on the branch, e.g. `feat/add-new-widget`
- Raise a PR back to `develop` once the feature is complete
- If the PR is accepted merge the branch into `develop`

Doing a release to staging:
- Merge `develop` into `staging`
- Deploy this branch into the UAT environment
- Run manual tests against this environment and gain sign-off to deploy

Doing a release to production:
- Ensure all sign-offs are in place
- Merge `staging` into `main`
    - To merge to main, the `production release` label must be applied to your pull request
- Deploy this branch into the production environment
- Perform any post go-live checks

For critical bug fixes on production
- Create a hotfix branch from `main`, e.g. `hotfix/update-service-name`
- Make changes on the branch
- Raise a PR back to `main` once the bug is fixed
    - To merge to main, the `production release` label must be applied to your pull request
- If the PR is accepted, merge the branch into `main`
- Then also merge the branch into `develop`

## Deployment

The site is deployed using github actions.

### Database migrations

Migrations will be run automatically on deployment. If a migration needs to be rolled back for any reason there are two options:
1. Create a new inverse migration and deploy that
2. Generate and run a rollback script
    1. Check out the same commit locally
    2. [Install EF Core CLI tools](https://docs.microsoft.com/en-us/ef/core/cli/dotnet) if you haven't already
    3. Generate a rollback script using `dotnet ef migrations script 2022010112345678_BadMigration 2022010112345678_LastGoodMigration -o revert.sql` from the `WhlgPortalWebsite` directory
    4. Review the script
    5. TODO Add instructions for running the script on the Azure environment

## Environments

This app is deployed to BEIS AWS platform

### Configuration

Non-secret configuration is stored in the corresponding `appsettings.<environment>.json` file:
- appsettings.DEV.json
- appsettings.UAT.json
- appsettings.Production.json

Secrets must be configured in the ECS tasks, corresponding to the variables in `secrets.json` above:
- `ConnectionStrings__PostgreSQLConnection`
- `GovUkNotify__ApiKey`
- `Authentication__Cognito__ClientId`
- `Authentication__Cognito__ClientSecret`
- `Authentication__Cognito__MetadataAddress`
- `Authentication__Cognito__SignOutUrl`

The S3 configuration is also configured in ECS, as it's linked to AWS resources
- `S3__BucketName`
- `S3__Region`
